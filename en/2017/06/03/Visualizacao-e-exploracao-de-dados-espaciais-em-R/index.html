<!DOCTYPE html><html lang="pt,en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="O Laboratório de Aprendizado de Máquina em Finanças e Organizações (LAMFO) é um centro destinado a desenvolver, aplicar e estudar fenômenos organizacionais nas mais diversas áreas como Marketing, Logística, Administração Pública, Gestão de Pessoas e Finanças."><meta name="author" content="LAMFO"><meta property="og:title" content="Visualização e exploração de dados espaciais em R"><meta property="og:description" content="O Laboratório de Aprendizado de Máquina em Finanças e Organizações (LAMFO) é um centro destinado a desenvolver, aplicar e estudar fenômenos organizacionais nas mais diversas áreas como Marketing, Logística, Administração Pública, Gestão de Pessoas e Finanças."><meta property="og:site_name" content="LAMFO"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><title>Visualização e exploração de dados espaciais em R - LAMFO</title><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-97417743-1","auto"),ga("send","pageview")</script><link rel="icon" href="/img/favicon.ico"></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Inicio</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav navbar-right"><li><a href="http://lamfo.unb.br/">Site</a></li><li><a href="/archives">Arquivos</a></li><li><a href="/data">Dados</a></li><li><a href="https://github.com/lamfo-unb">Github</a></li></ul></div></div></nav><header class="intro-header" style="background-image:url(/img/0018.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>Visualização e exploração de dados espaciais em R</h1><span class="meta">Posted by Marcelo Felix on 2017-06-03</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags"><a href="/tags/Georrefenciamento/">#Georrefenciamento</a></div><div class="col-lg-4 col-md-5 post-categories"></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h1 id="Visualizacao-e-exploracao-de-dados-espaciais-no-R"><a href="#Visualizacao-e-exploracao-de-dados-espaciais-no-R" class="headerlink" title="Visualização e exploração de dados espaciais no R"></a><strong><em>Visualização e exploração de dados espaciais no R</em></strong></h1><p>Neste post iremos nos basear no tutorial de Robin Lovelace et. al. (2017) e o material que será utilizado está disponível em seu <a href="https://www.github.com/Robinlovelace/Creating-maps-in-R" target="_blank" rel="external">repositorio</a> no Github, no projeto <em>Creating-maps-in-R.Rproj</em>.<br>Inicialmente, é preciso instalar os seguintes pacotes no R:<br><code>&quot;ggplot2&quot;, &quot;ggmap&quot;,&quot;rgdal&quot;,&quot;rgeos&quot;,&quot;maptools&quot;,&quot;dplyr&quot;,&quot;tidyr&quot;,&quot;tmap&quot;</code></p><p>Feita a instalação dos pacotes necessários, o primeiro passo é abrir a shape file. Aqui iremos nos basear no tutorial de Robin Lovelace et. al. (2017) e o material que será utilizado está disponível no <a href="https://www.github.com/Robinlovelace/Creating-maps-in-R" target="_blank" rel="external">link</a> no projeto <em>Creating-maps-in-R.Rproj</em>.</p><p>O shapefile é um formato de arquivo que armazena dados geoespaciais, como posição, forma e atributos, em forma de vetor. No RStudio a abertura desse tipo de arquivo pode ser feita da seguinte forma:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rgdal)</div><div class="line">lnd &lt;- readOGR(dsn = <span class="string">"data"</span>, layer = <span class="string">"london_sport"</span>)</div><div class="line">head(lnd@data, n = <span class="number">2</span>)</div><div class="line">sapply(lnd@data, class)</div></pre></td></tr></table></figure><p>A última linha do código mostra que a classe da variável <em>Pop_2001</em> está classificada como fator, enquanto deveria ser do tipo numérico. Portanto, devemos alterá-la:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lnd$Pop_2001 &lt;-  as.numeric(as.character(lnd$Pop_2001))</div><div class="line">sapply(lnd@data, class)</div></pre></td></tr></table></figure><p>Uma primeira análise pode ser feita com apenas selecionando as regiões que possuam determinado índice de participação no esporte:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sel &lt;- lnd$Partic_Per &gt; <span class="number">20</span> &amp; lnd$Partic_Per &lt; <span class="number">25</span></div><div class="line">plot(lnd, col = <span class="string">"lightgrey"</span>)</div><div class="line">plot(lnd[sel,], col = <span class="string">"turquoise"</span>, add = <span class="literal">TRUE</span>)</div></pre></td></tr></table></figure><p>Outra análise interessante é a identificação de quadrantes. Essa divisão pode ser feita tendo como base as coordenadas do centroide, que no caso representa o ponto central de Londres.</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(rgeos)</div><div class="line"><span class="comment">## encontrando o centro da região de londres</span></div><div class="line">lat &lt;- coordinates(gCentroid(lnd))[[<span class="number">1</span>]]</div><div class="line">lng &lt;- coordinates(gCentroid(lnd))[[<span class="number">2</span>]]</div><div class="line"><span class="comment">## argumento para testar se a região está ao norte ou ao leste do centro</span></div><div class="line">norte &lt;-  sapply(coordinates(lnd)[,<span class="number">2</span>], <span class="keyword">function</span>(x) x &gt; lng)</div><div class="line">leste &lt;- sapply(coordinates(lnd)[,<span class="number">1</span>], <span class="keyword">function</span>(x) x &gt; lat)</div><div class="line">oeste &lt;- sapply(coordinates(lnd)[,<span class="number">1</span>], <span class="keyword">function</span>(x) x &lt; lat)</div><div class="line">sul &lt;- sapply(coordinates(lnd)[,<span class="number">2</span>], <span class="keyword">function</span>(x) x &lt; lng)</div><div class="line"><span class="comment">## testando se a coordenada está a norte ou leste do centro</span></div><div class="line">lnd@data$quadrant[norte &amp; leste] &lt;- <span class="string">"nordeste"</span></div><div class="line">lnd@data$quadrant[norte &amp; oeste] &lt;- <span class="string">"noroeste"</span></div><div class="line">lnd@data$quadrant[sul &amp; leste] &lt;- <span class="string">"sudeste"</span></div><div class="line">lnd@data$quadrant[sul &amp; oeste] &lt;- <span class="string">"sudoeste"</span></div><div class="line"></div><div class="line"><span class="comment">## colorindo os quadrantes no gráfico</span></div><div class="line">sapply(lnd@data, class)</div><div class="line">lnd@data$quadrant &lt;- as.factor(as.character(lnd@data$quadrant))</div><div class="line">sapply(lnd@data, class)</div><div class="line">plot(lnd, col = <span class="string">"lightgrey"</span>)</div><div class="line">plot(lnd[norte &amp; leste,],col = <span class="string">"red"</span>, add = <span class="literal">TRUE</span>)</div><div class="line">plot(lnd[norte &amp; oeste,], col = <span class="string">"blue"</span>, add = <span class="literal">TRUE</span>)</div><div class="line">plot(lnd[sul &amp; leste,], col = <span class="string">"green"</span>, add = <span class="literal">TRUE</span>)</div><div class="line">plot(lnd[sul &amp; oeste,], col = <span class="string">"yellow"</span>, add = <span class="literal">TRUE</span>)</div></pre></td></tr></table></figure><h2 id="Criando-mapas-com-tmap-ggplot-e-leaflet"><a href="#Criando-mapas-com-tmap-ggplot-e-leaflet" class="headerlink" title="Criando mapas com tmap, ggplot e leaflet"></a>Criando mapas com tmap, ggplot e leaflet</h2><p><strong>Tmap</strong></p><p>A análise pode ser feita gerando um gradiente de cores com base na participação percentual da população no esporte:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(tmap)</div><div class="line">qtm(shp = lnd, fill = <span class="string">"Partic_Per"</span>, fill.palette = <span class="string">"-Blues"</span>)</div></pre></td></tr></table></figure><p><strong>ggplot2</strong></p><p>Diferentemente do tmap, o ggplot exige que você forneça a base de dados em formado de data.frame. Isto pode ser feito por meio da função fortify():</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(ggplot2)</div><div class="line"><span class="keyword">library</span>(dplyr)</div><div class="line">lnd_f &lt;- fortify(lnd)</div><div class="line">head(lnd_f, n = <span class="number">2</span>)</div><div class="line">lnd$id &lt;- row.names(lnd) <span class="comment"># Atribui um ID para a base sp </span></div><div class="line">head(lnd@data, n = <span class="number">2</span>) <span class="comment"># ultima checagem antes da junção (os nomes das variáveis precisam ser iguais)</span></div><div class="line">lnd_f &lt;-left_join(lnd_f, lnd@data) <span class="comment"># juntou pela única variável com nome em comum</span></div><div class="line">head(lnd_f, n = <span class="number">2</span>)</div></pre></td></tr></table></figure><p>Agora o objeto lnd_f pode ser utilizado para a criação de um mapa com ggplot:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">map&lt;-ggplot(lnd_f, aes(long, lat, group = group, fill = Partic_Per)) + </div><div class="line">  geom_polygon() + coord_equal() + </div><div class="line">  labs(x = <span class="string">"Easting (m)"</span>, y = <span class="string">"Northing (m)"</span>, fill = <span class="string">"% Sports\nParticipation"</span>) + </div><div class="line">  ggtitle(<span class="string">"London Sports Participation"</span>)</div><div class="line">map</div><div class="line"><span class="comment">## trocando as cores</span></div><div class="line">map + scale_fill_gradient(low = <span class="string">"red"</span>, high = <span class="string">"green"</span>)</div><div class="line"><span class="comment">## salvando o grafico com ggsave</span></div><div class="line">ggsave(<span class="string">"Sport Participation - London.jpg"</span>)</div></pre></td></tr></table></figure><p><strong>Mapas interativos com leaflet</strong></p><p>O pacote leaflet permite a criação de mapas interativos e age de forma conjunta com o pacote shiny, tornando possível a visualização online dos mapas. O objeto lnd está com um CRS (Coordinate Reference System) que não é compatível com o leaflet. A visualização será possível depois que o CRS do objeto lnd for alterado para o EPSG:4326, que tem sido o mais utilizado:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(leaflet)</div><div class="line">lnd84 &lt;- spTransform(lnd, CRS(<span class="string">"+init=epsg:4326"</span>)) <span class="comment">#reprojeta</span></div><div class="line">leaflet() %&gt;%</div><div class="line">   addTiles() %&gt;%</div><div class="line">   addPolygons(data = lnd84)</div></pre></td></tr></table></figure><iframe title="London Map" width="700" height="400" src="https://cdn.rawgit.com/jadermcs/fdb08a2c254288844c6ae4673e4e6e0b/raw/a92f7fdf0ec510d30504c934b3dcecbe8ab67fd3/london_map.html" frameborder="0" allowfullscreen></iframe><p>Esse mapa se diferencia dos outros por permitir uma interatividade semelhante à que se tem com a utilização do googlemaps no navegador.</p><p>A seguir temos mais um exemplo de visualização de uma determinada região no leaflet, porém agora será utilizado o arquivo shapefile do Distrito Federal, disponível no site do IBGE. Depois de baixar o arquivo e salvá-lo no seu Working Directory atual, o primeiro passo é atribuir o arquivo à um novo objeto, aqui denominado <em>df_shp</em>:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(raster)</div><div class="line"><span class="keyword">library</span>(sp)</div><div class="line">df_shp &lt;- readOGR(dsn = <span class="string">"df_setores_censitarios"</span>, layer = <span class="string">"53SEE250GC_SIR"</span>)</div><div class="line"></div><div class="line"><span class="comment"># Criação do mapa com leaflet</span></div><div class="line">df_shp@proj4string &lt;- CRS(<span class="string">"+init=epsg:4326"</span>) <span class="comment"># reprojeta</span></div><div class="line">df_leaf &lt;- leaflet(data = df_shp) %&gt;% addTiles()%&gt;%</div><div class="line">	addPolygons(fill = <span class="literal">FALSE</span>, weight = <span class="number">1</span>, stroke = <span class="literal">TRUE</span>, color = <span class="string">"#03F"</span>)%&gt;%</div><div class="line">	addLegend(<span class="string">"bottomright"</span>, colors = <span class="string">"#03F"</span>, labels = <span class="string">"Distrito Federal"</span>)</div><div class="line"></div><div class="line">df_leaf</div></pre></td></tr></table></figure><p>O código acima segue o mesmo raciocínio do criado para o mapa de Londres, porém com algumas configurações a mais. O arquivo .shp foi inserido diretamente na função leaflet e na função addPolygons foram incluídos os argumentos fill, weight, stroke e color, que representam respectivamente se o interior dos polígonos devem receber alguma cor, a espessura da linha de contorno, se as linhas dos polígonos devem ser coloridas e qual a cor escolhida. A função addLegend cria uma legenda para o mapa. Para mais detalhes sobre funções, basta rodar o seguinte comando: ?nomedafunção.</p><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-58f0d5c0f023693e"></script><div class="addthis_sharing_toolbox"></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><hr><h3>Comments:</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></div></article><hr><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href="https://www.facebook.com/lamfounb/" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/lamfo-unb" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href="mailto:lamfo/(at)unb/(dot)br" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">&copy; 2017 LAMFO<br></p><p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p><p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p></div></div></div></footer><script src="//code.jquery.com/jquery-2.1.4.min.js"></script><script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script><script type="text/javascript">var disqus_shortname="lamfo";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML,Safe"></script></body></html>